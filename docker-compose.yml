services:
  bootstrap:
    build:
      context: .
      target: bootstrap
    container_name: p2p-bootstrap
    ports:
      - "1099:1099"  # RMI Registry
      - "9876:9876/udp"  # UDP Heartbeat
    networks:
      - p2p-network
    healthcheck:
      test: ["CMD-SHELL", "timeout 2 bash -c '</dev/tcp/127.0.0.1/1099' || exit 1"]
      interval: 5s
      timeout: 3s
      retries: 5
      start_period: 10s

  alice:
    build:
      context: .
      target: peer
    container_name: p2p-alice
    command: ["--username", "Alice", "--port", "5001", "--bootstrap", "bootstrap:1099"]
    ports:
      - "5001:5001"
    networks:
      - p2p-network
    depends_on:
      bootstrap:
        condition: service_healthy
    stdin_open: true
    tty: true

  bob:
    build:
      context: .
      target: peer
    command: ["--username", "Bob", "--port", "5002", "--bootstrap", "bootstrap:1099"]
    container_name: p2p-bob
    ports:
      - "5002:5002"
    networks:
      - p2p-network
    depends_on:
      bootstrap:
        condition: service_healthy
    stdin_open: true
    tty: true

  charlie:
    build:
      context: .
      target: peer
    command: ["--username", "Charlie", "--port", "5003", "--bootstrap", "bootstrap:1099"]
    container_name: p2p-charlie
    ports:
      - "5003:5003"
    networks:
      - p2p-network
    depends_on:
      bootstrap:
        condition: service_healthy
    stdin_open: true
    tty: true
    profiles:
      - extended  # Only start with --profile extended

networks:
  p2p-network:
    driver: bridge
